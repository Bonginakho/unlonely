<!-- Modal 1: Weekly Ritual -->
<div class="modal fade" id="exampleModalToggle" aria-hidden="true" aria-labelledby="exampleModalToggleLabel" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalToggleLabel">Weekly Ritual</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        Show a second modal and hide this one with the button below.
      </div>
      <div class="modal-footer">
        <button class="btn btn-light" data-bs-target="#exampleModalToggle2" data-bs-toggle="modal">Process</button>
        <button class="btn btn-light" data-bs-target="#exampleModalToggle3" data-bs-toggle="modal">Alignment</button>
        <button class="btn btn-light" data-bs-target="#exampleModalToggle4" data-bs-toggle="modal">Clarity</button>
      </div>
    </div>
  </div>
</div>
<!-- Modal 2: Process -->
<div class="modal fade" id="exampleModalToggle2" aria-hidden="true" aria-labelledby="exampleModalToggleLabel2" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalToggleLabel2">Process</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>What is true about what I am feeling?</p>
        <p>What actions are within my control?</p>
        <p>Write your diary entry below:</p>
        <form id="diaryFormProcess">
          <div class="mb-3">
            <label for="diaryInputProcess" class="form-label">Your Entry</label>
            <textarea class="form-control" id="diaryInputProcess" rows="3" placeholder="Type your diary entry..." required></textarea>
          </div>
          <button type="submit" class="btn btn-primary">Save Entry</button>
        </form>
        <hr>
        <h5>Previous Entries:</h5>
        <ul id="entryListProcess" class="list-group"></ul>
      </div>
      <div class="modal-footer">
        <button class="btn btn-light" data-bs-target="#exampleModalToggle" data-bs-toggle="modal">Back to first</button>
      </div>
    </div>
  </div>
</div>
<!-- Modal 3: Alignment -->
<div class="modal fade" id="exampleModalToggle3" aria-hidden="true" aria-labelledby="exampleModalToggleLabel3" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalToggleLabel3">Alignment</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>How do I let the truth of what I am feeling, having let go of what is outside of my control, lead me today?</p>
        <p>These are the steps I will bring me into alignment with what I want:</p>
        <p>Write your diary entry below:</p>
        <form id="diaryFormAlignment">
          <div class="mb-3">
            <label for="diaryInputAlignment" class="form-label">Your Entry</label>
            <textarea class="form-control" id="diaryInputAlignment" rows="3" placeholder="Type your diary entry..." required></textarea>
          </div>
          <button type="submit" class="btn btn-primary">Save Entry</button>
        </form>
        <hr>
        <h5>Previous Entries:</h5>
        <ul id="entryListAlignment" class="list-group"></ul>
      </div>
      <div class="modal-footer">
        <button class="btn btn-light" data-bs-target="#exampleModalToggle" data-bs-toggle="modal">Back to first</button>
      </div>
    </div>
  </div>
</div>
<!-- Modal 4: Clarity -->
<div class="modal fade" id="exampleModalToggle4" aria-hidden="true" aria-labelledby="exampleModalToggleLabel4" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h1 class="modal-title fs-5" id="exampleModalToggleLabel4">Clarity</h1>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <p>What is in my mind?</p>
        <p>Don't overthink here. Just write down whatever is in your mind as you start your morning. Whatever you're into. Don't judge it. Just let whatever comes up make its way onto the page.</p>
        <p>Write your diary entry below:</p>
        <form id="diaryFormClarity">
          <div class="mb-3">
            <label for="diaryInputClarity" class="form-label">Your Entry</label>
            <textarea class="form-control" id="diaryInputClarity" rows="3" placeholder="Type your diary entry..." required></textarea>
          </div>
          <button type="submit" class="btn btn-primary">Save Entry</button>
        </form>
        <hr>
        <h5>Previous Entries:</h5>
        <ul id="entryListClarity" class="list-group"></ul>
      </div>
      <div class="modal-footer">
        <button class="btn btn-light" data-bs-target="#exampleModalToggle" data-bs-toggle="modal">Back to first</button>
      </div>
    </div>
  </div>
</div>
<!-- Bootstrap JS (make sure these are before your closing </body>) -->
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.6/dist/umd/popper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.min.js"></script>
<!-- Your custom JS script -->
<script>
  let currentEditIndexProcess = null;
  let currentEditIndexAlignment = null;
  let currentEditIndexClarity = null;

  // Load previous entries from local storage when DOM is ready
  document.addEventListener('DOMContentLoaded', function() {
    loadEntries();
  });

  function loadEntries() {
    loadEntriesForSection('Process');
    loadEntriesForSection('Alignment');
    loadEntriesForSection('Clarity');
  }

  function loadEntriesForSection(section) {
    const entries = JSON.parse(localStorage.getItem(`diaryEntries${section}`)) || [];
    const entryList = document.getElementById(`entryList${section}`);
    entryList.innerHTML = ''; // Clear existing

    entries.forEach((entry, index) => {
      const li = document.createElement('li');
      li.className = 'list-group-item d-flex justify-content-between align-items-center';
      li.textContent = entry;

      const editButton = document.createElement('button');
      editButton.className = 'btn btn-warning btn-sm';
      editButton.textContent = 'Edit';
      editButton.onclick = () => editEntry(section, index);
      li.appendChild(editButton);

      const deleteButton = document.createElement('button');
      deleteButton.className = 'btn btn-danger btn-sm';
      deleteButton.textContent = 'Delete';
      deleteButton.onclick = () => deleteEntry(section, index);
      li.appendChild(deleteButton);

      entryList.appendChild(li);
    });
  }

  // Form submit handlers
  document.getElementById('diaryFormProcess').addEventListener('submit', function(event) {
    event.preventDefault();
    const diaryText = document.getElementById('diaryInputProcess').value;
    saveEntry('Process', diaryText);
  });

  document.getElementById('diaryFormAlignment').addEventListener('submit', function(event) {
    event.preventDefault();
    const diaryText = document.getElementById('diaryInputAlignment').value;
    saveEntry('Alignment', diaryText);
  });

  document.getElementById('diaryFormClarity').addEventListener('submit', function(event) {
    event.preventDefault();
    const diaryText = document.getElementById('diaryInputClarity').value;
    saveEntry('Clarity', diaryText);
  });

  // Save or update entries
  function saveEntry(section, diaryText) {
    const entries = JSON.parse(localStorage.getItem(`diaryEntries${section}`)) || [];
    if (section === 'Process' && currentEditIndexProcess !== null) {
      entries[currentEditIndexProcess] = diaryText;
      currentEditIndexProcess = null;
    } else if (section === 'Alignment' && currentEditIndexAlignment !== null) {
      entries[currentEditIndexAlignment] = diaryText;
      currentEditIndexAlignment = null;
    } else if (section === 'Clarity' && currentEditIndexClarity !== null) {
      entries[currentEditIndexClarity] = diaryText;
      currentEditIndexClarity = null;
    } else {
      entries.push(diaryText);
    }
    localStorage.setItem(`diaryEntries${section}`, JSON.stringify(entries));
    loadEntriesForSection(section);
    document.getElementById(`diaryInput${section}`).value = '';
  }

  // Edit entries
  function editEntry(section, index) {
    const entries = JSON.parse(localStorage.getItem(`diaryEntries${section}`)) || [];
    document.getElementById(`diaryInput${section}`).value = entries[index];
    if (section === 'Process') currentEditIndexProcess = index;
    else if (section === 'Alignment') currentEditIndexAlignment = index;
    else if (section === 'Clarity') currentEditIndexClarity = index;
  }

  // Delete entries
  function deleteEntry(section, index) {
    const entries = JSON.parse(localStorage.getItem(`diaryEntries${section}`)) || [];
    entries.splice(index, 1);
    localStorage.setItem(`diaryEntries${section}`, JSON.stringify(entries));
    loadEntriesForSection(section);
  }
</script>
<div class="container" id="journal-heading">
  <h1> <%= @journal.week %></h1>
</div>
<% if @journal %>
  <div class="text-container">
    <!-- Button that triggers the first modal -->
    <button class="journal-button" style="margin-left: 0; margin-bottom: 4px" data-bs-target="#exampleModalToggle" data-bs-toggle="modal">Weekly Ritual</button>
    <p><%= @journal.prompt %></p>
    <% if @current_week == 1 %>
      <p>Go through the week and tick the box for each day you say hello to a stranger.</p>
      <div class="day-checklist">
        <form>
          <p><input type="checkbox" id="monday"   name="days" class="check-box"><label for="Monday">Monday</label></p>
          <p><input type="checkbox" id="tuesday"  name="days" class="check-box"><label for="Tuesday">Tuesday</label></p>
          <p><input type="checkbox" id="wednesday"name="days" class="check-box"><label for="Wednesday">Wednesday</label></p>
          <p><input type="checkbox" id="thursday" name="days" class="check-box"><label for="Thursday">Thursday</label></p>
          <p><input type="checkbox" id="friday"   name="days" class="check-box"><label for="Friday">Friday</label></p>
          <p><input type="checkbox" id="saturday" name="days" class="check-box"><label for="Saturday">Saturday</label></p>
          <p><input type="checkbox" id="sunday"   name="days" class="check-box"><label for="Sunday">Sunday</label></p>
        </form>
      </div>
    <% end %>
    <!-- write section-->
    <button class="toggle-form-button journal-button margin-top">Write</button>
    <div class="journal-form-container" style="display: none">
      <%= simple_form_for(@journal) do |j| %>
        <%= j.input :content, label: false, input_html: { value: "", class: 'form-control text-area', style: 'margin: 20px 0; padding: 10px; border: 4px solid black; border-radius: 10px;' } %>
        <%= j.submit "Save", class: "journal-button" %>
      <% end %>
    </div>
    <% if @journal.content.present?  %>
      <div class="journal-user-text">
        <h4> Your Thoughts </h4>
        <p><%= simple_format(@journal.content) %></p>
      </div>
    <% end %>
    <!-- Reflections -->
    <button class="journal-button reflection-container" style="margin-left: 0; margin-bottom: 4px">Reflections</button>
    <div class="container" style="margin-left: 0; margin-bottom: 4px; display: none;">
      <%= @journal.reflection.title %>
      <%= simple_form_for(@journal.reflection) do |j| %>
        <%= j.input :writing, label: false, input_html: { value: "", class: 'form-control text-area', style: 'margin: 20px 0; padding: 10px; border: 4px solid black; border-radius: 10px;' } %>
        <%= j.submit "Save", class: "journal-button" %>
      <% end %>
    </div>
    <% if @journal.reflection.writing.present? %>
      <div class="reflection-content">
        <h4>Your Reflection </h4>
        <p><%= simple_format(@journal.reflection.writing) %></p>
      </div>
    <% end %>
    <div class="week-navigation">
      <% if @has_previous %>
        <%= link_to "Previous Week", journals_path(week: @weeks[@weeks.index(@current_week) - 1]), class: "journal-button" %>
      <% end %>
      <% if @has_next %>
        <%= link_to "Next Week", journals_path(week: @weeks[@weeks.index(@current_week) + 1]), class: "journal-button" %>
      <% end %>
    </div>
  <% else  %>
    <p>No journal found for this week.</p>
  <% end %>
  </div>
</div>
<!--start with chat messages at the bottom to see the layout-->
<div class="chat-toggle-bubble" id="chat-button">
  <i class="fa-solid fa-comment"></i>
</div>
<div class="chat-container hidden" id="chat-container">
  <div class="logo-and-title">
    <%= image_tag "unlonely.png", class: "avatar-large", alt: "logo"%>
    <div class="title-text">
      <h2> Get Connected </h2>
      <p> You are worthy of knowing. </p>
    </div>
  </div>
  <div class="chat-content">
    <% if @chat_partner %>
      <div id="chat_messages">
        <%= turbo_frame_tag "chat_messages" do %>
          <%= render @chat_messages %>
        <% end %>
      </div>
      <div style="margin-top: 10px;">
        <%= turbo_frame_tag "new_chat_message" do %>
          <%= simple_form_for @chat_message, url: create_chat_message_journals_path, data: { turbo: true }, html: { id: "new_chat_message_form"} do |f| %>
            <%= f.hidden_field :receiver_id, value: @chat_partner.id %>
            <%= f.input :content, label: false, input_html: { autocomplete: "off", placeholder: "Type your message...", class:"chat-input" },
            wrapper: false
            %>
            <%= button_tag(type: "submit", class: "journal-button", style: "margin-top: 5px;") do %>
              Send
            <% end %>
          <% end %>
        <% end %>
      </div>
    <% else %>
      <p> Speak your truth and allow others to speak theirs. </p>
      <%= form_with url: journals_path, method: :get,  data: { turbo_frame: "chat_box" } do |form| %>
        <%= form.label :user_id, "Choose someone to connect with" %>
        <%= form.collection_select :user_id, User.where.not(id: current_user.id), :id, :username, prompt: "Choose a user" %>
        <%= form.submit "Start Chat", class: "journal-button", style: "margin-top: 10px;" %>
      <% end %>
    <% end %>
  </div>
</div>
<script>
  document.addEventListener("turbo:load", () => {
    const chatMessagesDiv = document.getElementById("chat_messages");
    if (chatMessagesDiv) {
      chatMessagesDiv.scrollTop = chatMessagesDiv.scrollHeight;
    }
  });

  document.addEventListener("turbo:frame-load", (event) => {
    if (event.target.id === "chat_messages") {
      event.target.scrollTop = event.target.scrollHeight;
    }
  });
</script>
